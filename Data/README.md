Структура папки Data:
- Data/Raw - корпуса в формате jsonlines, зафиксированном для данного проекта.
- Data/Interim - корпуса с разбивкой на подмножества, с дополнительными признаками, синтаксическим разбором и другими результатами предобработки.
- Data/Processed - корпуса в бинарном формате (если такие будут использоваться, скорее всего нет) и результаты предсказаний моделей.
- Data/External - Внешние данные, например словари по которым проводится нормализация.
# Формат корпусов для проекта
### Общая структура
Корпуса предлагаю хранить в формате Jsonlines, где каждая строка это json с обязательными полями: **meta**, **raw**, **objects**.
- В **meta** хранится информация о файлах и документах.
- В **raw** хранится текст документа.
- В **objects** храняться сущности, выделенные в документе, которые должны иметь поля **spans**, **text** и поля с нормализациями, возможные названия полей: MedDRA, ATC, MKB10, source_group, medform_standart.

Ниже подробно описан формат хранения корпуса RDR. Другие корпуса должны быть приведены к похожему формату. Некоторые поля естественно могут отсутствовать, но структура должна быть схожей. 
### RDR
Формат хранения корпуса RDR такой: jsonlines файл, каждая строка это json со следующими полями: **meta**, **raw**, **sentences**, **objects**, **coreference**, **context**

В **meta** хранятся:
- **fileName** - имя файла (или имя документа + расширение)
- **annotator** - пользователь, чья разметка была использована. Поле может отсутствовать, если автор разметки не известен
- **corpus** - 2 значения "main_2800" - если отзыв из основного корпуса и "adr_1k" - если из дополнительного

В **raw** хранится текст отзыва с заголовками, ссылкой и тэгами (TITLE, TEXT, RATING, NOTE).

В **sentences** хранится список предложений, каждое предложение - список слов, представленных как словари с полями: **forma** - словоформа из текста, **start** - позиция начала слова в тексте, **end** - позиция конца слова.

В **objects** есть вложенное поле MedEntity, в котором лежит список упоминаний из корпуса. Каждое упоминание это словарь со следующими полями : 
- **spans** - список спанов, из которых состоит упоминание. Каждый спан - словарь с полями **begin**, **end** (позиция начала спана  в тексте и конец спана, соответственно).
- **xmiID** - ID упоминания в пределах документа. Поле может отсутствовать для корпусов, полученных не из xmi формата.
- **text** - текст упоминания, сложенный из её спанов**
- **MedEntityType** - основной тип сущности (Medication, Disease, ADR, Note).
- **MedType** - подтип Medication (поле может отсутствовать, если это не Medication)
- **DisType** - подтип Disease (поле может отсутствовать, если это не Disease)
- **MedFrom** - поле присутствует только если **MedType**==Drugname. Может иметь одно из двух значений: Domestic, Foreign. Распространяется ли препарат на территории россии (Domestic) или только за границей (Foreign)
- **MedMaker** - поле присутствует только если **MedType**==MedMaker. Может иметь одно из двух значений: Domestic, Foreign. Является ли производитель препарата отечественным (Domestic) или иностранным (Foreign)
- **Context** - к каким контекстам в отзыве относится упоминание
- **ATC** - Код анатомо-терапевтически-химической классификации (если MedType== Drugname или Drugclass)
- **MKB10** - Код классификации МКБ-10 (если DisType==Diseasename)
- **MedDRA** - Термин уровня PT из MedDRA (если MedEntityType==ADR или DisType==Indication)
- **source_group** - группировочное название источника информации о препарате.
- **medform_standart** - стандартизированное название формы препарата.

В корпусе RDR будут еще присутствовать поля **coreference** и **context**

В **coreference** представлены кореферентные цепочки в следующем формате:
- поле **mentions** содержит список словарей упоминаний. Каждое упоминание - словарь с полями **startPos**, **endPos**, указывающими границы упоминания в тексте
- поле **clusters** содержит список цепочек (кластеров). Каждая цепочка это список индексов упоминаний из поля mentions, которые являются кореферентными
 
В **context** записаны контекстные цепочки. Тот же формат, что и **coreference**


### PsyTAR
Формат хранения корпуса PsyTAR такой: jsonlines файл, наследующий общую структуру, описанную выше.
Также содержат поле **sentences** - это поле из стандартного sagnlpjson формата, разве что posStart переименован на start, с posEnd аналогично.
Каждая сущность из **objects** MedEntity содержит также поля **sent_id** - номер предложения и **token_ids** - номера токенов в предложении
Поля нормализации следующие:
- **SNOMED-CT** - Код SNOMED
- **UMLS1** - Код UMLS
- **UMLS2** - У сущности может быть два кода UMLS одновременно, вот если UMLS1 уже есть, то далее идет UMLS2
- **SNOMED-CT.1** - Тоже код SNOMED, но хз в чем отличие от просто SNOMED-CT
Подготовить разбивку PsyTAR можно зайдя в  ./Data/Interim/PsyTAR и запустив код Prepare_PsyTAR.py, он сформирует две папки с разными разбивками. Описание этих разбивок представлено в репо sag111/RelationExtraction/data/raw/PsyTAR/

## Поля нормализации
У некоторых сущностей могут присутствовать поля **ATC**, **MKB10**, **MedDRA**,**Normalization**. В них может быть записана фраза из словаря или класс из классификатора, которая соответствует этому упоминанию. Упоминания следующих типов из корпуса RDR могут иметь поле **Normalization**: 
- Medication:Drugname и Medication:Drugclass приведены к категориями из класификатора АТХ. В поле Normalization записан только код категории.
- Medication:SourceInfodrug - приведены к нескольким категориям, которые мы посчитали значимыми
- Medication:Drugform приведены к лекарственным формам, перечисленным в приказе минздрава РФ от 27.07.2016 N 538н "Об утверждении перечня наименований лекарственных форм лекарственных препаратов для медицинского применения"
- Disease:Diseasename приведены к категориям из классификатора МКБ-10, в поле Normalization записан только код.
- Disease:Indication, ADR приведены к словарю prefered tems (PT) из MedDRA. В поле записан сам термин из словаря.

Наибольший интерес представляют как раз Indication и ADR. Но они на данный момент проходят проверку и доразметку для доп. корпуса. Drugform должно быть относительно просто, кроме некоторых случаев. SourceInfodrug - это скорее классификация нежели нормализация, так не уверен, что есть какое-то внимание на этом заострять. Diseasename, Drugname и Drugclass - тоже скорее классификация, но более интересная, там много разных категорий в классификаторах и соотнести термин с категорией может быть сложно.

В корпусе RDR, одинаковые упоминания (с одинаковым текстом) могут иметь разные значения в зависимости от текста в котором они встречаются. Такое встречается редко, но возможно.

Некоторые упоминания могут иметь несколько вариантов нормализации. Они записаны через вертикальную черту "|" в поле Normalization. По хорошему, при обучении и оценки моделей надо считать правильным любой из предложенных вариантов. Но сначала надо посчитать, сколько таких случаев, стоит ли на счёт них заморачиваться, или лучше поставить случайный из всех возможных, или наиболее популярный.

Некоторые упоминания могут иметь пустое поле Normalization. Это значит, что разметчикам не удалось подобрать подходящий термин или категорию. Таким надо игнорировать при обучении.

## уровни иерархии
Для Drugname, Drugclass, Diseasename разметчики старались проставлять категории как можно более низкого уровня, но иногда это было не возможно, поэтому могут встречаться и более высокие уровни иерархий. 

Для ADR и Indication разметчики использовали уровень LLT из MedDRA. Но интерес представляет на самом деле уровень PT. Поэтому при переводе таблиц разметчиков в корпус в описанном выше формате LLT должны приводиться к PT.

Для Drugform и SourceInfodrug никаких иерархий нет.

Кроме того, я считаю, что ошибки модели, когда она указала не верную категорию, но принадлежащую к той правильной категории более высокого уровня, должны учитываться менее строго. 

## словари
Словари по которым проводится нормализация лежат в Data/External.
- ATC.csv - файл содержащий анатомо-терапевтически-химическую классификацию. В колонке code содержится код АТХ следующего вида: буква+2цифры+буква+буква+2цифры - так кодируются 5 уровней иерархии, classification - расшифровка кода (название категории)
- mkb10.csv - файл, содержащий МКБ классификацию. Самый нижний уровень - четырехзначные подрубрики, записаны так: буква+2цифры+точка+цифра, например M49.8; уровень выше - трехзначная рубрика, например M49; уровень выше - блок трёхзначных рубрик, например A00-A09; самый верхний уровень - класс, записывается похоже на блок, например A00-B99. В таблице колонки: Код диагноза, Название диагноза, Код родителя.
- mkb10_git_modified.csv - тоже самое, но кодов почему-то чуть больше, однако некоторые коды в МКБ содержат символ крест (+) или звезда * , а в этом файле этих символов нет.


## Особенности корпуса rdr
Что-то я сюда хотел написать...


## Разбивка на трейн тест
Будет ли кросс валидация?

Надо разбить так, чтоб были сущности (словарные), которые есть только в тесте, были те, которые слабо представлены в трейне, сильно представлены в трейне. Это усложняется если принимать во внимание иерархическую структуру словарей.

# Описания корпусов:
**Data/Raw/medNorm_14012022.jsonlines** - !!!В этой версии корпуса обнаружена ошибка, ADR не имели нормализации!!!. разметка взята из проекта med_NNreview (дамп 10.01.2022) (для основного корпуса из 2800 отзывов) и med-reviews_1kADR (дамп 11.01.2022). По нормализации для основного корпуса проведена проверка Drugname, Diseasename, Drugform, SourceInfoDrug. Требует доработки: Drugclass, ADR (половина проверена), Indication. По дополнительному корпусу проведена разметка Drugname, Diseasename, Drugform, SourceInfoDrug, Drugclass. Разметка ADR и Indication в процессе. Рекомендуется проверка: Drugname, Diseasename, Drugform, SourceInfoDrug, Drugclass
**Data/Raw/medNorm_16022022.jsonlines** - разметка взята из проекта med_NNreview (дамп 11.02.2022) (для основного корпуса из 2800 отзывов) и med-reviews_1kADR (дамп 11.02.2022). По нормализации для основного корпуса проведена проверка Drugname, Diseasename, Drugform, SourceInfoDrug, ADR. Требует доработки: Drugclass, Indication. По дополнительному корпусу проведена разметка Drugname, Diseasename, Drugform, SourceInfoDrug, Drugclass, ADR, Indication. Рекомендуется проверка: Drugname, Diseasename, Drugform, SourceInfoDrug, Drugclass, ADR, Indication